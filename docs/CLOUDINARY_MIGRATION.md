# تحديث استخدام Cloudinary لجميع الصور

## نظرة عامة

تم تحديث التطبيق لاستخدام **Cloudinary** لجميع أنواع الصور بدلاً من التخزين المحلي، مما يوفر:

- **أمان أفضل**: تخزين آمن في السحابة
- **أداء محسن**: تحميل أسرع للصور
- **قابلية التوسع**: دعم عدد كبير من الصور
- **نسخ احتياطي تلقائي**: حماية من فقدان البيانات
- **تحسين الصور**: تحويل تلقائي للأحجام المناسبة

## التغييرات المطبقة

### 1. تحديث مسار الـ uploads العام (`server/routes/uploads.js`)

```javascript
// قبل: تخزين محلي
const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    const uploadPath = path.join(process.cwd(), 'server', 'uploads');
    // ...
  }
});

// بعد: Cloudinary
const storage = new CloudinaryStorage({
  cloudinary: cloudinary,
  params: {
    folder: 'general-uploads',
    allowed_formats: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
    transformation: [{ width: 800, height: 800, crop: 'limit' }],
  },
});
```

### 2. تحديث مسار العملاء (`server/routes/clients.js`)

- إضافة دعم Cloudinary لصور العملاء
- حذف الصور القديمة من Cloudinary عند التحديث
- مجلد مخصص: `clients`

### 3. تحديث مسار المستخدمين (`server/routes/users.js`)

- إضافة دعم Cloudinary لصور المستخدمين
- حذف الصور القديمة من Cloudinary عند التحديث
- مجلد مخصص: `users`

### 4. تحديث الواجهة الأمامية

#### Layout.tsx
- تحديث `getPhotoUrl` للتعامل مع روابط Cloudinary
- تحديث رفع صور المستخدمين لاستخدام مسار المستخدمين مباشرة

#### Clients.tsx
- تحديث عرض صور العملاء للتعامل مع روابط Cloudinary
- تحديث رسائل الخطأ لاستخدام صورة افتراضية مناسبة

#### Products.tsx
- تحديث عرض صور المنتجات للتعامل مع روابط Cloudinary
- تحديث رسائل الخطأ لاستخدام صورة افتراضية مناسبة

#### Orders.tsx
- تحديث عرض صور العملاء في جدول الطلبات
- تحديث عرض صور المنتجات في جدول الطلبات
- إصلاح مشكلة عدم ظهور صور العملاء

#### Offers.tsx
- تحديث رسائل الخطأ لاستخدام صورة افتراضية مناسبة

#### ExhibitionDashboard.tsx
- تحديث عرض صور المنتجات في لوحة المعرض
- إضافة دعم روابط Cloudinary

#### WarehouseDashboard.tsx
- تحديث عرض صور المنتجات في لوحة المستودع
- إضافة دعم روابط Cloudinary

## إعدادات Cloudinary المطلوبة

تأكد من وجود المتغيرات التالية في ملف `.env`:

```env
Cloud_NAME=your_cloud_name
API_KEY=your_api_key
API_SECRET=your_api_secret
```

## مجلدات Cloudinary

- **`products`**: صور المنتجات (800x800 بكسل)
- **`clients`**: صور العملاء (400x400 بكسل)
- **`users`**: صور المستخدمين (400x400 بكسل)
- **`general-uploads`**: الصور العامة (800x800 بكسل)

## التوافق مع البيانات القديمة

التطبيق يدعم كلاً من:
- **الروابط الجديدة**: روابط Cloudinary (تبدأ بـ `http`)
- **الروابط القديمة**: الروابط المحلية (تبدأ بـ `/uploads/`)

## المزايا الجديدة

1. **تحسين تلقائي للصور**: تحويل للأحجام المناسبة
2. **حذف تلقائي**: حذف الصور القديمة عند التحديث
3. **أمان محسن**: تخزين آمن في السحابة
4. **أداء أفضل**: تحميل أسرع للصور
5. **قابلية التوسع**: دعم عدد كبير من الصور

## الصفحات المحدثة

### ✅ الصفحات المكتملة:
- **Layout.tsx**: ✅ تم التحديث
- **Clients.tsx**: ✅ تم التحديث
- **Products.tsx**: ✅ تم التحديث
- **Orders.tsx**: ✅ تم التحديث
- **Offers.tsx**: ✅ تم التحديث
- **ExhibitionDashboard.tsx**: ✅ تم التحديث
- **WarehouseDashboard.tsx**: ✅ تم التحديث

### ✅ المكونات المحدثة:
- **OfferModal.tsx**: ✅ لا يحتاج تحديث
- **Sidebar.tsx**: ✅ لا يحتاج تحديث
- **ProtectedRoute.tsx**: ✅ لا يحتاج تحديث

### ✅ السياقات المحدثة:
- **AuthContext.tsx**: ✅ لا يحتاج تحديث
- **ThemeContext.tsx**: ✅ لا يحتاج تحديث
- **LanguageContext.tsx**: ✅ لا يحتاج تحديث

## المشاكل التي تم إصلاحها

1. **عدم ظهور صور العملاء في جدول الطلبات**: تم إصلاح طريقة عرض صور العملاء
2. **رسائل الخطأ غير المناسبة**: تم توحيد استخدام `/logo.png` كصورة افتراضية
3. **عدم دعم روابط Cloudinary**: تم إضافة دعم كامل لروابط Cloudinary
4. **تناقض في طريقة التخزين**: تم توحيد استخدام Cloudinary لجميع الصور

## ملاحظات مهمة

- تأكد من وجود اتصال بالإنترنت لرفع الصور
- الصور القديمة المحفوظة محلياً ستبقى متاحة حتى يتم حذفها يدوياً
- يمكن حذف مجلد `server/uploads` بعد التأكد من عمل النظام الجديد
- جميع الصور الجديدة ستُحفظ في Cloudinary تلقائياً

## اختبار النظام

بعد تطبيق التحديثات، تأكد من اختبار:
1. رفع صور العملاء الجديدة
2. رفع صور المنتجات الجديدة
3. رفع صور المستخدمين الجديدة
4. عرض الصور في جميع الجداول
5. عرض الصور في النماذج المنبثقة
6. عرض الصور في لوحات المعلومات 